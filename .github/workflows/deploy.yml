name: ğŸš€ é˜¿é‡Œäº‘ OSS å¢é‡éƒ¨ç½²

on:
  push:
    branches: 
      - main

jobs:
  sync-to-oss:
    runs-on: ubuntu-latest
    name: ğŸ”— å¢é‡åŒæ­¥é™æ€æ–‡ä»¶
    steps:
      - name: ğŸ“‚ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”„ æ‰§è¡Œå¢é‡åŒæ­¥
        run: |
          # 1. ä¸‹è½½ ossutil 2.0 (ä½¿ç”¨ GitHub Release é“¾æ¥ï¼Œæå…¶ç¨³å®š)
          # ç›´æ¥ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶å¹¶ä¿å­˜ä¸º ossutil
          wget -q -O ossutil https://github.com/aliyun/ossutil/releases/download/v2.0.3-beta.02061300/ossutil-linux-amd64

          # 2. éªŒè¯ä¸‹è½½ (é‡è¦ï¼šé˜²æ­¢ä¸‹è½½åˆ° HTML é”™è¯¯é¡µ)
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”ä¸ä¸ºç©º
          if [ ! -s ossutil ]; then
            echo " ossutil ä¸‹è½½å¤±è´¥ï¼Œæ–‡ä»¶ä¸ºç©ºï¼"
            exit 1
          fi

          # 3. å®‰è£…å¹¶èµ‹äºˆæ‰§è¡Œæƒé™
          sudo mv ossutil /usr/local/bin/ossutil
          sudo chmod +x /usr/local/bin/ossutil

          # 4. è®¾ç½®ç¯å¢ƒå˜é‡ (ossutil 2.0 ä¼šè‡ªåŠ¨è¯»å–è¿™äº›å˜é‡)
          export OSS_ACCESS_KEY_ID=$
          export OSS_ACCESS_KEY_SECRET=${{ secrets.ALIYUN_OSS_ACCESS_KEY_SECRET }}
          export OSS_ENDPOINT=${{ secrets.ALIYUN_OSS_ENDPOINT }}

          # 5. æ‰§è¡ŒåŒæ­¥ (æ ¸å¿ƒé€»è¾‘)
          # --delete: è‡ªåŠ¨åˆ é™¤ OSS ä¸Šæœ¬åœ°æ²¡æœ‰çš„æ–‡ä»¶
          # --update: ä»…åŒæ­¥æ›´æ–°çš„æ–‡ä»¶
          # --exclude: æ’é™¤ä¸éœ€è¦çš„ç³»ç»Ÿ/æ—¥å¿—æ–‡ä»¶
          # --force: å¼ºåˆ¶æ‰§è¡Œ
          ossutil sync ./ oss://${{ secrets.ALIYUN_OSS_BUCKET }} \
            --delete \
            --update \
            --exclude=".git*" \
            --exclude=".github*" \
            --exclude="*.log" \
            --exclude="tmp*" \
            --exclude=".DS_Store" \
            --force
