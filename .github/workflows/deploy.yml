name: ðŸš€ é˜¿é‡Œäº‘ OSS å¢žé‡éƒ¨ç½²

on:
  push:
    branches: 
      - main  # ç›‘å¬ main åˆ†æ”¯çš„æŽ¨é€

jobs:
  sync-to-oss:
    runs-on: ubuntu-latest
    name: ðŸ”— å…¨è‡ªåŠ¨åŒæ­¥é™æ€æ–‡ä»¶
    steps:
      # 1. æ‹‰å–ä»£ç åˆ°å·¥ä½œæµè™šæ‹Ÿæœº
      - name: ðŸ“‚ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          # å¿…é¡»è®¾ç½®ä¸º 0ï¼ŒèŽ·å–å®Œæ•´çš„ Git åŽ†å²ï¼Œç¡®ä¿èƒ½æ­£ç¡®è¯†åˆ«æ‰€æœ‰æ–‡ä»¶å˜æ›´
          fetch-depth: 0

      # 2. å®‰è£…ä¾èµ–å¹¶æ‰§è¡ŒåŒæ­¥
      - name: ðŸ”„ æ‰§è¡ŒåŒå‘åŒæ­¥
        run: |
          # 1. ä¸‹è½½å¹¶æ‰§è¡Œå®˜æ–¹å®‰è£…è„šæœ¬
          # ä½¿ç”¨ sudo ç¡®ä¿æœ‰æƒé™å®‰è£…åˆ°ç³»ç»Ÿç›®å½•
          curl -s https://gosspublic.alicdn.com/ossutil/install.sh | sudo bash

          # 2. åˆ›å»º ossutil çš„é…ç½®æ–‡ä»¶
          # å°† Secrets æ³¨å…¥é…ç½®æ–‡ä»¶
          cat > ~/.ossutilconfig << EOF
          [Credentials]
          language=CH
          accessKeyID=${{ secrets.ALIYUN_OSS_ACCESS_KEY_ID }}
          accessKeySecret=${{ secrets.ALIYUN_OSS_ACCESS_KEY_SECRET }}
          endpoint=${{ secrets.ALIYUN_OSS_ENDPOINT }}
          EOF

          # 3. æ‰§è¡ŒåŒæ­¥æ“ä½œ (æ ¸å¿ƒæ”¹åŠ¨ç‚¹)
          # ./www : ä½ çš„æœ¬åœ°ç½‘ç«™ç›®å½•
          # oss://... : ä½ çš„ Bucket åœ°å€
          # sync : ä½¿ç”¨åŒæ­¥å‘½ä»¤ä»£æ›¿ cpï¼Œå®ƒä¼šæ¯”å¯¹ä¸¤è¾¹çš„æ–‡ä»¶
          # --delete : â­ï¸ å…³é”®å‚æ•°ï¼å¦‚æžœæœ¬åœ°æ²¡æœ‰è¯¥æ–‡ä»¶ï¼ŒOSS ä¸Šçš„å¯¹åº”æ–‡ä»¶ä¹Ÿä¼šè¢«åˆ é™¤
          # --force : å¼ºåˆ¶æ‰§è¡Œï¼Œä¸è¿›è¡Œäº¤äº’å¼ç¡®è®¤
          # --update : ä»…å½“æ–‡ä»¶æ›´æ–°æ—¶æ‰ä¼ è¾“ï¼ˆå¢žé‡ä¼ è¾“ï¼ŒèŠ‚çœæµé‡ï¼‰
          ossutil sync ./ oss://${{ secrets.ALIYUN_OSS_BUCKET }} --delete --update --force
