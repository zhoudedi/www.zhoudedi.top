name: ğŸš€ é˜¿é‡Œäº‘ OSS å¢é‡éƒ¨ç½²

on:
  push:
    branches: 
      - main

jobs:
  sync-to-oss:
    runs-on: ubuntu-latest
    name: ğŸ”— å¢é‡åŒæ­¥é™æ€æ–‡ä»¶
    steps:
      - name: ğŸ“‚ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”„ æ‰§è¡Œå¢é‡åŒæ­¥
        run: |
          # 1. ä¸‹è½½ ossutil 2.0 (å…³é”®ï¼šä¼ªè£…æˆ Wget ä¸‹è½½ï¼Œé¿å…è¢« CDN æ‹¦æˆª)
          # å¦‚æœä¸åŠ  -H å¤´ï¼Œæœ‰æ—¶ä¼šä¸‹è½½åˆ°ä¸€ä¸ª XML é”™è¯¯æ–‡ä»¶ï¼Œå¯¼è‡´è¯­æ³•é”™è¯¯
          curl -sSL -H "User-Agent: Wget" -o ossutil https://gosspublic.alicdn.com/ossutil/v2/ossutil2-linux-amd64
          
          # 2. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸‹è½½æˆåŠŸ (é˜²å¾¡æ€§ç¼–ç¨‹)
          # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨æˆ–è€…æ–‡ä»¶å¤§å°ä¸º 0ï¼Œè¯´æ˜ä¸‹è½½å¤±è´¥äº†
          if [ ! -s ossutil ]; then
            echo " ä¸‹è½½ ossutil å¤±è´¥ï¼æ–‡ä»¶ä¸ºç©ºæˆ–æŸåã€‚"
            exit 1
          fi

          # 3. å®‰è£…åˆ°ç³»ç»Ÿè·¯å¾„å¹¶èµ‹äºˆæ‰§è¡Œæƒé™
          sudo mv ossutil /usr/local/bin/ossutil
          sudo chmod 755 /usr/local/bin/ossutil

          # 4. è®¾ç½®ç¯å¢ƒå˜é‡ (ossutil 2.0 ä¼šè‡ªåŠ¨è¯»å–è¿™äº›å˜é‡)
          export OSS_ACCESS_KEY_ID=$
          export OSS_ACCESS_KEY_SECRET=${{ secrets.ALIYUN_OSS_ACCESS_KEY_SECRET }}
          export OSS_ENDPOINT=${{ secrets.ALIYUN_OSS_ENDPOINT }}

          # 5. æ‰§è¡ŒåŒæ­¥ (æ ¸å¿ƒé€»è¾‘)
          # --delete: è‡ªåŠ¨åˆ é™¤ OSS ä¸Šæœ¬åœ°æ²¡æœ‰çš„æ–‡ä»¶
          # --update: ä»…åŒæ­¥æ›´æ–°çš„æ–‡ä»¶
          # --exclude: æ’é™¤ä¸éœ€è¦çš„ç³»ç»Ÿ/æ—¥å¿—æ–‡ä»¶
          ossutil sync ./ oss://${{ secrets.ALIYUN_OSS_BUCKET }} \
            --delete \
            --update \
            --exclude=".git*" \
            --exclude=".github*" \
            --exclude="*.log" \
            --exclude="tmp*" \
            --exclude=".DS_Store" \
            --force
